### 优化后的ekf配置文件 ###
ekf_filter_node:
    ros__parameters:
        # 输出频率（Hz），与传感器超时匹配
        frequency: 100.0
        # 传感器超时时间（秒），超过此时长仅预测不校正
        sensor_timeout: 0.1

        # 启用平面模式（忽略z轴冗余噪声，适合地面移动机器人）
        two_d_mode: true

        # TF变换相关配置（当前禁用，如需导航可改为true）
        transform_time_offset: 0.0
        transform_timeout: 10.0
        publish_tf: false

        # 诊断与调试（保留打印诊断方便调试）
        print_diagnostics: true
        debug: false
        debug_out_file: /path/to/debug/file.txt
        permit_corrected_publication: false
        publish_acceleration: false

        # 坐标系配置（遵循REP-105规范）
        map_frame: map
        odom_frame: odom
        base_link_frame: base_link
        world_frame: odom  # 基于odom的局部定位，无全局跳变

        odom0: /odom  # 输入的原始里程计话题
        odom0_config: [true,  true,  false,  # 融合x、y位置（z禁用，平面模式）
                       false, false, false,  # 不融合姿态（由IMU负责）
                       true,  true,  false,  # 融合x、y线速度（z禁用）
                       false, false, true,   # 融合yaw角速度（旋转速度）
                       false, false, false]  # 不融合加速度（由IMU负责）
        odom0_queue_size: 6  # 队列大小适配高频数据
        odom0_nodelay: false
        odom0_differential: false
        odom0_relative: false
        # 里程计数据异常值过滤阈值（Mahalanobis距离）
        odom0_pose_rejection_threshold: 5.0
        odom0_twist_rejection_threshold: 1.0

        # IMU输入配置（保留高频姿态/角速度/加速度融合）
        imu0: /imu  # IMU话题（根据实际话题名调整）
        imu0_config: [false, false, false,   # 不融合位置（由里程计负责）
                      true,  true,  true,    # 融合roll、pitch、yaw姿态（IMU优势）
                      false, false, false,   # 不融合线速度（由里程计负责）
                      true,  true,  true,    # 融合角速度（补充旋转细节）
                      true,  true,  true]    # 融合线加速度（动态响应优化）
        imu0_nodelay: false
        imu0_differential: false
        imu0_relative: false
        imu0_queue_size: 10  # 适配IMU高频特性（通常100Hz以上）
        # 调整IMU阈值：放宽姿态和加速度过滤，避免有效数据被误判
        imu0_pose_rejection_threshold: 1.0                # 姿态阈值从0.5放宽至1.0
        imu0_twist_rejection_threshold: 1.0
        imu0_linear_acceleration_rejection_threshold: 1.5  # 加速度阈值从0.8放宽至1.5
        # 启用重力加速度去除（需IMU数据符合ENU帧，REP-103规范）
        imu0_remove_gravitational_acceleration: true


        # 控制输入配置（可选启用，优化动态预测）
        use_control: false  # 若有cmd_vel话题可改为true
        stamped_control: false
        control_timeout: 0.2
        control_config: [true, false, false, false, false, true]  # 适配差速机器人（vx、vyaw可控）
        acceleration_limits: [1.3, 0.0, 0.0, 0.0, 0.0, 3.4]
        deceleration_limits: [1.3, 0.0, 0.0, 0.0, 0.0, 4.5]
        acceleration_gains: [0.8, 0.0, 0.0, 0.0, 0.0, 0.9]
        deceleration_gains: [1.0, 0.0, 0.0, 0.0, 0.0, 1.0]

        # 过程噪声协方差（默认值，平面模式下无需调整z轴）
        process_noise_covariance: [0.05, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.05, 0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.06, 0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.03, 0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.03, 0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.06, 0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.025, 0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.025, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.04, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.01, 0.0,    0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.01, 0.0,    0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.02, 0.0,    0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.01, 0.0,    0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.01, 0.0,
                                   0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.015]

        # 初始估计协方差（默认值，平面模式下无需调整z轴）
        initial_estimate_covariance: [1e-3, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    1e-3, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    1e-6, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    1e-3, 0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    1e-3, 0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    1e-9, 0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-9, 0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-9, 0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-9, 0.0,     0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    1e-9,  0.0,     0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     1e-9,  0.0,     0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     1e-9,  0.0,    0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     1e-9, 0.0,    0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    1e-9, 0.0,
                                      0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,    0.0,     0.0,     0.0,     0.0,    0.0,    1e-9]