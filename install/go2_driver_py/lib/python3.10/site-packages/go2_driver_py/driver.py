import rclpy
from rclpy.node import Node
# 消息类型导入
from nav_msgs.msg import Odometry
from unitree_go.msg import SportModeState, LowState
from geometry_msgs.msg import PoseStamped, TransformStamped
from sensor_msgs.msg import JointState
# TF广播器
from tf2_ros import TransformBroadcaster

class Driver(Node):
    def __init__(self):
        super().__init__('driver')
        self.get_logger().info('Driver节点创建, 用于发布里程计消息，坐标变换和关节状态信息')
        
        # 声明并获取参数
        self.declare_parameter('publish_tf', True)
        self.publish_tf = self.get_parameter('publish_tf').get_parameter_value().bool_value
        
        # 初始化TF广播器
        self.tf_bro = TransformBroadcaster(self)
        
        # 订阅者创建
        self.sub = self.create_subscription(
            SportModeState,
            '/lf/sportmodestate',
            self.state_cb,
            10
        )
        self.robot_pose_sub = self.create_subscription(
            PoseStamped,
            '/utlidar/robot_pose',
            self.pose_callback,
            10
        )
        self.low_state_sub = self.create_subscription(
            LowState,
            '/lf/lowstate',
            self.low_state_cb,
            10
        )
        
        # 发布者创建
        self.odom_pub = self.create_publisher(Odometry, 'odom', 10)
        self.joint_state_pub = self.create_publisher(JointState, 'joint_states', 10)
        
        # 成员变量初始化（显式设为float）
        self.odom_published_ = False
        self.body_height_ = float(0.0)  # 初始化为float

    def state_cb(self, state_msg):
        # 计算车身高度
        self.body_height_ = float(state_msg.body_height) + float(0.057) - float(0.046825)

    def low_state_cb(self, low_state):
        # 组装并发布关节状态消息
        joint_state = JointState()
        joint_state.header.stamp = self.get_clock().now().to_msg()
        joint_state.name = [
            "FL_hip_joint", "FL_thigh_joint", "FL_calf_joint",
            "FR_hip_joint", "FR_thigh_joint", "FR_calf_joint",
            "RL_hip_joint", "RL_thigh_joint", "RL_calf_joint",
            "RR_hip_joint", "RR_thigh_joint", "RR_calf_joint"
        ]
        
        # 提取关节位置信息（显式转为float）
        for i in range(12):
            motor = low_state.motor_state[i]
            joint_state.position.append(float(motor.q))  # 关节角度转为float
        
        self.joint_state_pub.publish(joint_state)

    def pose_callback(self, msg):
        # 计算并广播坐标变换
        transform = TransformStamped()
        transform.header.stamp = self.get_clock().now().to_msg()
        transform.header.frame_id = 'odom'
        transform.child_frame_id = 'base_footprint'
        
        # 坐标转换计算
        # x方向平移：机器人pose的x减去偏移量
        transform.transform.translation.x = float(msg.pose.position.x) - float(0.28945)
        # y方向平移：直接取pose的y
        transform.transform.translation.y = float(msg.pose.position.y)
        # z方向平移：pose的z减去车身高度
        transform.transform.translation.z = float(msg.pose.position.z) - float(self.body_height_)
        
        # 旋转四元数（每个分量均转为float）
        transform.transform.rotation.x = float(msg.pose.orientation.x)
        transform.transform.rotation.y = float(msg.pose.orientation.y)
        transform.transform.rotation.z = float(msg.pose.orientation.z)
        transform.transform.rotation.w = float(msg.pose.orientation.w)
        
        self.tf_bro.sendTransform(transform)
        
        # 仅发布一次里程计消息
        if not self.odom_published_:
            odom = Odometry()
            odom.header.stamp = self.get_clock().now().to_msg()
            odom.header.frame_id = 'odom'
            odom.child_frame_id = 'base_footprint'
            
            # 里程计位置
            odom.pose.pose.position.x = transform.transform.translation.x
            odom.pose.pose.position.y = transform.transform.translation.y
            odom.pose.pose.position.z = transform.transform.translation.z
            
            # 里程计姿态
            odom.pose.pose.orientation.x = float(msg.pose.orientation.x)
            odom.pose.pose.orientation.y = float(msg.pose.orientation.y)
            odom.pose.pose.orientation.z = float(msg.pose.orientation.z)
            odom.pose.pose.orientation.w = float(msg.pose.orientation.w)
            
            self.odom_pub.publish(odom)
            self.odom_published_ = True

def main(args=None):
    rclpy.init(args=args)
    driver_node = Driver()
    rclpy.spin(driver_node)
    driver_node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()