import rclpy
from rclpy.node import Node
from unitree_go.msg import LowState
from sensor_msgs.msg import Imu
from tf2_ros import TransformBroadcaster
from geometry_msgs.msg import TransformStamped

class LowStateToImuNode(Node):
    def __init__(self):
        super().__init__("lowstate_to_imu_node")
        
        # 1. 订阅 LowState 消息
        self.lowstate_sub = self.create_subscription(
            LowState,
            "/lf/lowstate",
            self.lowstate_callback,
            10
        )
        
        # 2. 发布标准 Imu 话题
        self.imu_pub = self.create_publisher(Imu, "/imu", 10)
        
        # 3. 创建 TF 发布器
        self.tf_broadcaster = TransformBroadcaster(self)
        
        self.get_logger().info("IMU 转换节点已启动")

    def lowstate_callback(self, lowstate_msg):
        # 创建 IMU 消息
        imu_msg = Imu()
        
        imu_msg.header.stamp = self.get_clock().now().to_msg()
        imu_msg.header.frame_id = "imu"

        # 四元数转换（Unitree 格式 [w,x,y,z] → ROS [x,y,z,w]）
        # 关键：显式转换为 float 类型
        quat = lowstate_msg.imu_state.quaternion
        imu_msg.orientation.x = float(quat[1])  # 转换为 float
        imu_msg.orientation.y = float(quat[2])
        imu_msg.orientation.z = float(quat[3])
        imu_msg.orientation.w = float(quat[0])

        # 角速度（单位：rad/s），显式转换为 float
        imu_msg.angular_velocity.x = float(lowstate_msg.imu_state.gyroscope[0])
        imu_msg.angular_velocity.y = float(lowstate_msg.imu_state.gyroscope[1])
        imu_msg.angular_velocity.z = float(lowstate_msg.imu_state.gyroscope[2])
        
        # 加速度，显式转换为 float
        imu_msg.linear_acceleration.x = float(lowstate_msg.imu_state.accelerometer[0])
        imu_msg.linear_acceleration.y = float(lowstate_msg.imu_state.accelerometer[1])
        imu_msg.linear_acceleration.z = float(lowstate_msg.imu_state.accelerometer[2])

        # 协方差矩阵初始化（默认全为0）
        imu_msg.angular_velocity_covariance = [0.0] * 9
        imu_msg.linear_acceleration_covariance = [0.0] * 9
        imu_msg.orientation_covariance = [0.0] * 9
        
        # 角速度协方差（显式float）
        imu_msg.angular_velocity_covariance[0] = float(0.0002)  # xx
        imu_msg.angular_velocity_covariance[4] = float(0.0002)  # yy
        imu_msg.angular_velocity_covariance[8] = float(0.0002)  # zz
        
        # 线性加速度协方差（显式float）
        imu_msg.linear_acceleration_covariance[0] = float(0.02)  # xx
        imu_msg.linear_acceleration_covariance[4] = float(0.02)  # yy
        imu_msg.linear_acceleration_covariance[8] = float(0.02)  # zz
        
        # 方向协方差（-1表示未知，显式float）
        imu_msg.orientation_covariance[0] = float(-1.0)

        # 发布 IMU 消息
        self.imu_pub.publish(imu_msg)

        # 发布 TF 变换
        self.publish_tf_transform()

    def publish_tf_transform(self):
        tf = TransformStamped()
        
        tf.header.stamp = self.get_clock().now().to_msg()
        tf.header.frame_id = "base_link"
        tf.child_frame_id = "imu"
        
        # IMU相对于base_link的位置（显式转换为float）
        tf.transform.translation.x = float(-0.02557)  # 前向偏移2.557cm
        tf.transform.translation.y = float(0.0)
        tf.transform.translation.z = float(0.04232)   # 向上偏移4.232cm
        
        # 四元数（单位四元数，显式转换为float）
        tf.transform.rotation.x = float(0.0)
        tf.transform.rotation.y = float(0.0)
        tf.transform.rotation.z = float(0.0)
        tf.transform.rotation.w = float(1.0)
        
        # 发送TF变换
        self.tf_broadcaster.sendTransform(tf)

def main(args=None):
    rclpy.init(args=args)
    node = LowStateToImuNode()
    rclpy.spin(node)
    rclpy.shutdown()

if __name__ == "__main__":
    main()